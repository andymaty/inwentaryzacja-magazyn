<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inwentaryzacja Magazynu - V9 (v2b - naprawa funkcji)</title>
    
    <!-- PWA Meta Tags for Mobile Install -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Inwentaryzacja">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Inwentaryzacja">
    
    <!-- Icons for PWA -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>đź“¦</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%233b82f6'/><text y='.9em' x='.1em' font-size='80' fill='white'>đź“¦</text></svg>">
    
    <!-- Manifest for PWA -->
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Inwentaryzacja Magazynu&quot;,&quot;short_name&quot;:&quot;Inwentaryzacja&quot;,&quot;description&quot;:&quot;System zarzÄ…dzania magazynem z AI&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%23f3f4f6&quot;,&quot;theme_color&quot;:&quot;%233b82f6&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%233b82f6'/><text y='.9em' x='.1em' font-size='150' fill='white'>đź“¦</text></svg>&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%233b82f6'/><text y='.9em' x='.1em' font-size='400' fill='white'>đź“¦</text></svg>&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .suggestions { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; background: white; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f0f0f0; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; }
        .pagination button { padding: 8px 16px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .pagination button:hover { background: #f0f0f0; }
        .pagination button.active { background: #3b82f6; color: white; }
        .loading { display: none; text-align: center; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f0f0f0; }
        .editable { cursor: pointer; position: relative; }
        .editable:hover { background-color: #e6f3ff; }
        .edit-input { width: 100%; padding: 4px; border: 1px solid #3b82f6; border-radius: 4px; }
        .action-buttons button { margin-right: 5px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete:hover { background: #dc2626; }
        .debug-info { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
        .search-active { background-color: #fff3cd; border: 2px solid #ffc107; }
        .install-prompt { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .install-button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .install-button:hover { background: rgba(255,255,255,0.3); }
        @media (max-width: 768px) {
            .modal-content { margin: 2% auto; width: 95%; }
            table { font-size: 12px; }
            th, td { padding: 8px 4px; }
            .action-buttons button { padding: 3px 6px; font-size: 10px; }
            body { padding-bottom: 20px; } /* Space for mobile keyboards */
        }
        @media (display-mode: standalone) {
            .install-prompt { display: none; } /* Hide install prompt when running as PWA */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Install Prompt for Mobile -->
    <div id="installPrompt" class="install-prompt" style="display: none;">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-bold">đź“± Zainstaluj aplikacjÄ™</h3>
                <p class="text-sm opacity-90">Dodaj do ekranu gĹ‚Ăłwnego dla szybszego dostÄ™pu</p>
            </div>
            <div class="flex gap-2">
                <button id="installButton" class="install-button">
                    <i class="fas fa-download mr-1"></i>Zainstaluj
                </button>
                <button id="dismissInstall" class="install-button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-boxes mr-2 text-blue-600"></i>
                Inwentaryzacja Magazynu - V9
            </h1>
            <p class="text-gray-600">System zarzÄ…dzania zapasami z DeepSeek AI + ZarzÄ…dzanie lokalizacjami</p>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <button id="voiceBtn" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-microphone mr-2"></i>Dodaj gĹ‚osowo (AI)
                </button>
                <button id="importBtn" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-upload mr-2"></i>Import CSV
                </button>
                <button id="exportBtn" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>Export CSV
                </button>
                <button id="locationsBtn" class="bg-orange-600 text-white p-4 rounded-lg hover:bg-orange-700 transition-colors">
                    <i class="fas fa-map-marker-alt mr-2"></i>ZarzÄ…dzaj lokalizacjami
                </button>
                <button id="debugBtn" class="bg-gray-600 text-white p-4 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-bug mr-2"></i>Debug Info
                </button>
                <button id="clearBtn" class="bg-red-600 text-white p-4 rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>WyczyĹ›Ä‡ V9
                </button>
            </div>
        </div>

        <!-- Stats Display -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="totalItems">0</div>
                    <div class="text-sm text-gray-600">Wszystkich przedmiotĂłw</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="activeItems">0</div>
                    <div class="text-sm text-gray-600">Aktywnych</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="totalValue">0 PLN</div>
                    <div class="text-sm text-gray-600">WartoĹ›Ä‡ magazynu</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600" id="categories">0</div>
                    <div class="text-sm text-gray-600">Kategorii</div>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex gap-3 mb-4">
                <input type="text" id="searchInput" placeholder="Szukaj przedmiotĂłw, numerĂłw katalogowych..." 
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="searchBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>Szukaj
                </button>
                <button id="clearSearchBtn" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors" style="display: none;">
                    <i class="fas fa-times mr-2"></i>WyczyĹ›Ä‡
                </button>
            </div>
            <div id="searchSuggestions" class="suggestions" style="display: none;"></div>
            <div id="searchInfo" class="mt-4 text-sm text-blue-600" style="display: none;"></div>
        </div>

        <!-- Debug Info -->
        <div id="debugSection" class="bg-white rounded-lg shadow-lg p-6 mb-6" style="display: none;">
            <h3 class="text-lg font-semibold mb-4">Debug Information - V9</h3>
            <div id="debugInfo" class="debug-info">Brak informacji debugowych</div>
        </div>

        <!-- Inventory Table -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h2 class="text-xl font-semibold">
                    <i class="fas fa-list mr-2"></i>Wszystkie przedmioty
                </h2>
                <div class="flex gap-2">
                    <select id="filterStatus" class="p-2 border border-gray-300 rounded-lg">
                        <option value="">Wszystkie statusy</option>
                        <option value="aktywny">Aktywne</option>
                        <option value="usuniÄ™ty">UsuniÄ™te</option>
                    </select>
                    <select id="filterLocation" class="p-2 border border-gray-300 rounded-lg">
                        <option value="">Wszystkie lokalizacje</option>
                    </select>
                    <select id="filterCategory" class="p-2 border border-gray-300 rounded-lg">
                        <option value="">Wszystkie kategorie</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Lokalizacja</th>
                            <th>Przedmiot</th>
                            <th>Producent</th>
                            <th>Nr kat.</th>
                            <th>IloĹ›Ä‡</th>
                            <th>Cena</th>
                            <th>Status</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        <tr>
                            <td colspan="9" class="text-center p-8">
                                <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">Brak danych. Kliknij "Import CSV" aby wczytaÄ‡ bazÄ™ danych.</p>
                                <p class="text-sm text-gray-400 mt-2">Wersja V9 - PWA z zarzÄ…dzaniem lokalizacjami</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevPage">Â« Poprzednia</button>
                <span id="pageInfo"></span>
                <button id="nextPage">NastÄ™pna Â»</button>
            </div>
        </div>
    </div>

    <!-- Voice Modal -->
    <div id="voiceModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">
                    <i class="fas fa-microphone mr-2"></i>Dodawanie gĹ‚osowe - V9 (PWA)
                </h3>
                <span class="close">&times;</span>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Aktualna lokalizacja:</label>
                <select id="voiceLocation" class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="">Wybierz lokalizacjÄ™</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Tekst do przetworzenia:</label>
                <textarea id="voiceText" rows="6" class="w-full p-3 border border-gray-300 rounded-lg" 
                          placeholder="Opisz przedmioty ktĂłre chcesz dodaÄ‡ z WSZYSTKIMI szczegĂłĹ‚ami...&#10;&#10;PrzykĹ‚ad: 2 opakowania 5-litrowe oleju 10W40 kaĹĽde po 74 zĹ‚&#10;noĹĽyce do blachy Yato dĹ‚ugoĹ›Ä‡ 40mm cena 85 zĹ‚&#10;15 osĹ‚on przegubĂłw uniwersalnych Dura Bot po 16 zĹ‚ sztuka"></textarea>
            </div>

            <div class="mb-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <h4 class="font-semibold text-yellow-800 mb-2">đź’ˇ WskazĂłwki dla lepszego rozpoznawania:</h4>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>â€˘ Podawaj WSZYSTKIE szczegĂłĹ‚y: rozmiary, objÄ™toĹ›ci, dĹ‚ugoĹ›ci, szerokoĹ›ci</li>
                    <li>â€˘ UĹĽywaj peĹ‚nych nazw firm: "Yato", "Dura Bot", "Mann", "Bosch"</li>
                    <li>â€˘ OkreĹ›laj typ opakowania: "5-litrowe", "1kg", "zestaw", "komplet"</li>
                    <li>â€˘ Dodawaj specyfikacje: "uniwersalne", "zewnÄ™trzne", "wewnÄ™trzne"</li>
                </ul>
            </div>

            <div class="flex gap-3 mb-4">
                <button id="processVoice" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-brain mr-2"></i>PrzetwĂłrz przez AI
                </button>
                <button id="clearVoice" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-eraser mr-2"></i>WyczyĹ›Ä‡
                </button>
            </div>

            <div id="aiResults" style="display: none;">
                <h4 class="font-semibold mb-3">Wyniki przetwarzania AI:</h4>
                <div id="aiResultsList" class="bg-gray-50 p-4 rounded-lg mb-4"></div>
                <div class="flex gap-3">
                    <button id="saveItems" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                        <i class="fas fa-save mr-2"></i>Zapisz przedmioty
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button id="cancelVoice" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">Anuluj</button>
            </div>

            <div id="processingMessage" class="text-center text-blue-600 mt-4" style="display: none;">
                <i class="fas fa-spinner fa-spin mr-2"></i>Przetwarzanie przez DeepSeek AI...
            </div>
        </div>
    </div>

    <!-- Locations Modal -->
    <div id="locationsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">
                    <i class="fas fa-map-marker-alt mr-2"></i>ZarzÄ…dzanie lokalizacjami - V9
                </h3>
                <span class="close">&times;</span>
            </div>

            <div class="mb-6">
                <h4 class="font-semibold mb-3">Dodaj nowÄ… lokalizacjÄ™:</h4>
                <div class="flex gap-3">
                    <input type="text" id="newLocationInput" placeholder="Nazwa lokalizacji (np. Sklep - PĂłĹ‚ka A)" 
                           class="flex-1 p-3 border border-gray-300 rounded-lg">
                    <button id="addLocationBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Dodaj
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <h4 class="font-semibold mb-3">IstniejÄ…ce lokalizacje:</h4>
                <div id="locationsList" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Locations will be populated here -->
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="closeLocationsModal" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">
                    <i class="fas fa-upload mr-2"></i>Import CSV - V9
                </h3>
                <span class="close">&times;</span>
            </div>
            <div class="mb-4">
                <input type="file" id="csvFileInput" accept=".csv" class="w-full p-3 border border-gray-300 rounded-lg">
                <p class="text-sm text-gray-500 mt-2">Wybierz plik CSV z danymi (obsĹ‚uguje polskie znaki)</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Tryb importu:</label>
                <select id="importMode" class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="replace">ZastÄ…p wszystkie dane (POLECANE)</option>
                    <option value="append">Dodaj do istniejÄ…cych</option>
                </select>
            </div>
            <div id="importPreview" class="mb-4" style="display: none;">
                <h4 class="font-semibold mb-2">PodglÄ…d importu:</h4>
                <div id="importStats" class="bg-blue-50 p-3 rounded text-sm"></div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancelImport" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">Anuluj</button>
                <button id="processImport" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-upload mr-2"></i>Importuj
                </button>
            </div>
        </div>
    </div>

    <script>
        // System logowania
        function checkLogin() {
            const validLogin = 'andy';
            const validPassword = 'Kosztorystosyf21@';
            const sessionKey = 'inwentaryzacja_logged_in';
            
            // SprawdĹş czy uĹĽytkownik jest juĹĽ zalogowany w tej sesji
            if (sessionStorage.getItem(sessionKey) === 'true') {
                // JuĹĽ zalogowany, uruchom aplikacjÄ™
                app = new InventoryApp();
                return true;
            }
            
            // PokaĹĽ formularz logowania
            const loginHtml = `
                <div id="loginModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                     background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                         text-align: center; max-width: 400px; width: 90%;">
                        <h2 style="margin-bottom: 30px; color: #333;">đź”’ Logowanie do systemu inwentaryzacyjnego</h2>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Login:</label>
                            <input type="text" id="loginInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; 
                                   border-radius: 4px; font-size: 16px;" placeholder="WprowadĹş login">
                        </div>
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">HasĹ‚o:</label>
                            <input type="password" id="passwordInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; 
                                   border-radius: 4px; font-size: 16px;" placeholder="WprowadĹş hasĹ‚o">
                        </div>
                        <button onclick="attemptLogin()" style="width: 100%; padding: 12px; background: #3b82f6; color: white; 
                                border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                            Zaloguj siÄ™
                        </button>
                        <div id="loginError" style="color: red; margin-top: 15px; display: none;">
                            BĹ‚Ä™dny login lub hasĹ‚o!
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', loginHtml);
            
            // Ukryj gĹ‚ĂłwnÄ… zawartoĹ›Ä‡
            document.querySelector('.container').style.display = 'none';
            
            // ObsĹ‚uga Enter w polach logowania
            document.getElementById('loginInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') attemptLogin();
            });
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') attemptLogin();
            });
            
            return false;
        }
        
        function attemptLogin() {
            const login = document.getElementById('loginInput').value;
            const password = document.getElementById('passwordInput').value;
            const validLogin = 'andy';
            const validPassword = 'Kosztorystosyf21@';
            
            if (login === validLogin && password === validPassword) {
                // Logowanie udane
                sessionStorage.setItem('inwentaryzacja_logged_in', 'true');
                document.getElementById('loginModal').remove();
                document.querySelector('.container').style.display = 'block';
                
                // Dodaj przycisk wylogowania w prawym gĂłrnym rogu
                const logoutBtn = document.createElement('div');
                logoutBtn.innerHTML = '<button onclick="logout()" style="position: fixed; top: 10px; right: 10px; ' +
                    'background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; ' +
                    'cursor: pointer; z-index: 1000; font-size: 12px;">Wyloguj</button>';
                document.body.appendChild(logoutBtn);
                
                // Uruchom normalnÄ… inicjalizacjÄ™ aplikacji
                app = new InventoryApp();
            } else {
                // Logowanie nieudane
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        function logout() {
            sessionStorage.removeItem('inwentaryzacja_logged_in');
            location.reload();
        }

        // GĹ‚Ăłwny kod aplikacji - V9 specific
            
        // Global variables - V9 specific
        let currentData = [];
        let filteredData = [];
        let isSearchActive = false;
        let currentPage = 1;
        let itemsPerPage = 50;
        let pendingAIItems = [];
        let deferredInstallPrompt = null;
        let locations = [];

        // DeepSeek AI Configuration
        const DEEPSEEK_API_KEY = 'sk-63131981686c41399c7b43007a913de0';
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/chat/completions';

        // V9 Storage keys - separate from previous versions
        const STORAGE_KEY = 'inventoryData_v9_andy';
        const LOCATIONS_KEY = 'locations_v9_andy';

        // PWA Install functionality
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('đź“± PWA install prompt available');
            e.preventDefault();
            deferredInstallPrompt = e;
            
            // Show custom install prompt
            const installPrompt = document.getElementById('installPrompt');
            const installButton = document.getElementById('installButton');
            const dismissButton = document.getElementById('dismissInstall');
            
            installPrompt.style.display = 'block';
            
            installButton.addEventListener('click', async () => {
                console.log('đź“˛ User clicked install');
                installPrompt.style.display = 'none';
                
                if (deferredInstallPrompt) {
                    const choiceResult = await deferredInstallPrompt.prompt();
                    console.log('đźŽŻ User choice:', choiceResult.outcome);
                    deferredInstallPrompt = null;
                }
            });
            
            dismissButton.addEventListener('click', () => {
                console.log('âťŚ User dismissed install prompt');
                installPrompt.style.display = 'none';
                localStorage.setItem('installPromptDismissed', 'true');
            });
            
            // Don't show if previously dismissed
            if (localStorage.getItem('installPromptDismissed') === 'true') {
                installPrompt.style.display = 'none';
            }
        });

        // Service Worker registration (basic PWA functionality)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create a simple service worker for caching
                const swCode = `
                    const CACHE_NAME = 'inwentaryzacja-v9-cache';
                    const urlsToCache = [];
                    
                    self.addEventListener('install', (event) => {
                        console.log('đź“¦ Service Worker installed');
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', (event) => {
                        console.log('âś… Service Worker activated');
                        event.waitUntil(clients.claim());
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        // Let browser handle all requests (no aggressive caching)
                        return;
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('âś… SW registered:', registration);
                    })
                    .catch((error) => {
                        console.log('âťŚ SW registration failed:', error);
                    });
            });
        }

        class InventoryApp {
            constructor() {
                console.log('đźš€ Inwentaryzacja Magazynu V9 - v2b (naprawa funkcji)');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadFromLocalStorage();
                this.loadLocationsFromStorage();
                this.displayInventoryTable();
                this.updateStats();
                this.loadFilterOptions();
                this.showDebugInfo();
                console.log('âś… Aplikacja V9 zainicjalizowana');
            }

            setupEventListeners() {
                // Buttons
                document.getElementById('voiceBtn').addEventListener('click', () => this.showVoiceModal());
                document.getElementById('importBtn').addEventListener('click', () => this.showImportModal());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportCSV());
                document.getElementById('locationsBtn').addEventListener('click', () => this.showLocationsModal());
                document.getElementById('searchBtn').addEventListener('click', () => this.performSearch());
                document.getElementById('clearSearchBtn').addEventListener('click', () => this.clearSearch());
                document.getElementById('debugBtn').addEventListener('click', () => this.toggleDebugInfo());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAllData());
                
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => this.handleSearchInput(e));
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.performSearch();
                });

                // Filters
                document.getElementById('filterStatus').addEventListener('change', () => this.applyFilters());
                document.getElementById('filterLocation').addEventListener('change', () => this.applyFilters());
                document.getElementById('filterCategory').addEventListener('change', () => this.applyFilters());

                // Pagination
                document.getElementById('prevPage').addEventListener('click', () => this.changePage(-1));
                document.getElementById('nextPage').addEventListener('click', () => this.changePage(1));

                // Voice Modal
                document.getElementById('processVoice').addEventListener('click', () => this.processVoiceText());
                document.getElementById('clearVoice').addEventListener('click', () => this.clearVoiceText());
                document.getElementById('saveItems').addEventListener('click', () => this.saveAIItems());
                document.getElementById('cancelVoice').addEventListener('click', () => this.closeVoiceModal());

                // Locations Modal
                document.getElementById('addLocationBtn').addEventListener('click', () => this.addLocation());
                document.getElementById('newLocationInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addLocation();
                });
                document.getElementById('closeLocationsModal').addEventListener('click', () => this.closeLocationsModal());

                // Import Modal
                document.getElementById('csvFileInput').addEventListener('change', () => this.previewCSV());
                document.getElementById('processImport').addEventListener('click', () => this.processCSVImport());
                document.getElementById('cancelImport').addEventListener('click', () => this.closeImportModal());

                // Close modals
                document.querySelectorAll('.close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', (e) => {
                        e.target.closest('.modal').style.display = 'none';
                    });
                });

                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }

            // Location Management Functions
            showLocationsModal() {
                this.displayLocationsList();
                document.getElementById('locationsModal').style.display = 'block';
                document.getElementById('newLocationInput').focus();
            }

            closeLocationsModal() {
                document.getElementById('locationsModal').style.display = 'none';
                document.getElementById('newLocationInput').value = '';
            }

            addLocation() {
                const locationInput = document.getElementById('newLocationInput');
                const locationName = locationInput.value.trim();
                
                if (!locationName) {
                    this.showError('WprowadĹş nazwÄ™ lokalizacji');
                    return;
                }

                if (locations.includes(locationName)) {
                    this.showError('Ta lokalizacja juĹĽ istnieje');
                    return;
                }

                locations.push(locationName);
                this.saveLocationsToStorage();
                this.displayLocationsList();
                this.loadFilterOptions();
                locationInput.value = '';
                this.showSuccess(`Dodano lokalizacjÄ™: "${locationName}"`);
                console.log(`đź“Ť Dodano lokalizacjÄ™: ${locationName}`);
            }

            removeLocation(locationName) {
                if (!confirm(`Czy na pewno chcesz usunÄ…Ä‡ lokalizacjÄ™ "${locationName}"?\n\nUwaga: Przedmioty z tej lokalizacji nie zostanÄ… usuniÄ™te.`)) {
                    return;
                }

                locations = locations.filter(loc => loc !== locationName);
                this.saveLocationsToStorage();
                this.displayLocationsList();
                this.loadFilterOptions();
                this.showSuccess(`UsuniÄ™to lokalizacjÄ™: "${locationName}"`);
                console.log(`đź—‘ď¸Ź UsuniÄ™to lokalizacjÄ™: ${locationName}`);
            }

            displayLocationsList() {
                const locationsList = document.getElementById('locationsList');
                
                if (locations.length === 0) {
                    locationsList.innerHTML = `
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <i class="fas fa-map-marker-alt text-2xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500">Brak zdefiniowanych lokalizacji</p>
                            <p class="text-sm text-gray-400">Dodaj pierwszÄ… lokalizacjÄ™ powyĹĽej</p>
                        </div>
                    `;
                    return;
                }

                locationsList.innerHTML = locations.map(location => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                            <span class="font-medium">${location}</span>
                            <span class="text-sm text-gray-500 ml-2">
                                (${currentData.filter(item => item.Lokalizacja === location).length} przedmiotĂłw)
                            </span>
                        </div>
                        <button class="text-red-600 hover:text-red-800" onclick="app.removeLocation('${location}')" title="UsuĹ„ lokalizacjÄ™">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            loadFilterOptions() {
                // Load locations for filters
                const filterLocation = document.getElementById('filterLocation');
                filterLocation.innerHTML = '<option value="">Wszystkie lokalizacje</option>';
                locations.forEach(location => {
                    filterLocation.innerHTML += `<option value="${location}">${location}</option>`;
                });

                // Load locations for voice modal
                const voiceLocation = document.getElementById('voiceLocation');
                voiceLocation.innerHTML = '<option value="">Wybierz lokalizacjÄ™</option>';
                locations.forEach(location => {
                    voiceLocation.innerHTML += `<option value="${location}">${location}</option>`;
                });

                // Add fallback location if none exist
                if (locations.length === 0) {
                    const fallbackLocation = 'Sklep - RegaĹ‚ gĹ‚Ăłwny';
                    voiceLocation.innerHTML += `<option value="${fallbackLocation}">${fallbackLocation}</option>`;
                }

                // Load categories for filters  
                const filterCategory = document.getElementById('filterCategory');
                const categories = [...new Set(currentData.map(item => item.Kategoria))].filter(Boolean);
                filterCategory.innerHTML = '<option value="">Wszystkie kategorie</option>';
                categories.forEach(category => {
                    filterCategory.innerHTML += `<option value="${category}">${category}</option>`;
                });
            }

            saveLocationsToStorage() {
                localStorage.setItem(LOCATIONS_KEY, JSON.stringify(locations));
                console.log(`đź’ľ Zapisano ${locations.length} lokalizacji do localStorage`);
            }

            loadLocationsFromStorage() {
                const data = localStorage.getItem(LOCATIONS_KEY);
                if (data) {
                    locations = JSON.parse(data);
                    console.log(`đź“‚ ZaĹ‚adowano ${locations.length} lokalizacji z localStorage`);
                } else {
                    // Extract locations from current data if exists
                    const dataLocations = [...new Set(currentData.map(item => item.Lokalizacja))].filter(Boolean);
                    if (dataLocations.length > 0) {
                        locations = dataLocations;
                        this.saveLocationsToStorage();
                        console.log(`đź“Ť WyodrÄ™bniono ${locations.length} lokalizacji z danych`);
                    } else {
                        locations = [];
                        console.log('đź“‚ Brak lokalizacji - rozpoczynamy z pustÄ… listÄ…');
                    }
                }
            }

            getCurrentDisplayData() {
                let displayData = currentData;

                // Apply search filter
                if (isSearchActive) {
                    displayData = filteredData;
                }

                // Apply status filter
                const statusFilter = document.getElementById('filterStatus').value;
                if (statusFilter) {
                    displayData = displayData.filter(item => item.Status === statusFilter);
                }

                // Apply location filter
                const locationFilter = document.getElementById('filterLocation').value;
                if (locationFilter) {
                    displayData = displayData.filter(item => item.Lokalizacja === locationFilter);
                }

                // Apply category filter
                const categoryFilter = document.getElementById('filterCategory').value;
                if (categoryFilter) {
                    displayData = displayData.filter(item => item.Kategoria === categoryFilter);
                }
                
                return displayData;
            }

            displayInventoryTable() {
                const tbody = document.getElementById('inventoryTable');
                const displayData = this.getCurrentDisplayData();
                
                if (displayData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center p-8">
                                <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">${isSearchActive ? 'Nie znaleziono wynikĂłw wyszukiwania.' : 'Brak danych. Kliknij "Import CSV" aby wczytaÄ‡ bazÄ™ danych.'}</p>
                                <p class="text-sm text-gray-400 mt-2">Wersja V9 - PWA z zarzÄ…dzaniem lokalizacjami</p>
                            </td>
                        </tr>
                    `;
                    document.getElementById('pagination').style.display = 'none';
                    return;
                }

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageItems = displayData.slice(startIndex, endIndex);

                tbody.innerHTML = pageItems.map(item => `
                    <tr class="${item.Status === 'usuniÄ™ty' ? 'bg-red-50' : ''} ${isSearchActive ? 'search-active' : ''}">
                        <td>${item.ID}</td>
                        <td class="text-xs">${item.Lokalizacja || '-'}</td>
                        <td class="editable font-medium" onclick="app.editField(${item.ID}, 'Przedmiot')">${item.Przedmiot || '-'}</td>
                        <td>${item.Producent || '-'}</td>
                        <td class="font-mono text-sm">${item.Numer_katalogowy || '-'}</td>
                        <td class="text-center">${item.Ilosc || 0} ${item.Jednostka || 'szt'}</td>
                        <td class="text-right font-medium">${this.formatCurrency(item.Cena_PLN)}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${item.Status === 'aktywny' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                                ${item.Status || 'aktywny'}
                            </span>
                        </td>
                        <td class="action-buttons">
                            <button class="btn-edit" onclick="app.editItem(${item.ID})" title="Edytuj">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="app.deleteItem(${item.ID})" 
                                    ${item.Status === 'usuniÄ™ty' ? 'disabled' : ''} title="UsuĹ„">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                this.updatePagination(displayData.length);
                document.getElementById('pagination').style.display = displayData.length > itemsPerPage ? 'flex' : 'none';
            }

            formatCurrency(price) {
                if (!price || price === 0) return '-';
                const numPrice = parseFloat(price);
                return isNaN(numPrice) ? '-' : numPrice.toFixed(2) + ' PLN';
            }

            updatePagination(totalItems) {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                const pageInfo = document.getElementById('pageInfo');
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');

                pageInfo.textContent = `Strona ${currentPage} z ${totalPages} (${totalItems} pozycji)`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            }

            updateStats() {
                const stats = {
                    total: currentData.length,
                    active: currentData.filter(item => item.Status === 'aktywny').length,
                    categories: [...new Set(currentData.map(item => item.Kategoria).filter(Boolean))].length,
                    totalValue: 0
                };

                currentData.filter(item => item.Status === 'aktywny').forEach(item => {
                    const price = parseFloat(item.Cena_PLN) || 0;
                    const quantity = parseInt(item.Ilosc) || 0;
                    stats.totalValue += price * quantity;
                });

                console.log(`đź“Š V9 Stats Update:`, stats);

                // Update UI
                document.getElementById('totalItems').textContent = stats.total;
                document.getElementById('activeItems').textContent = stats.active;
                document.getElementById('totalValue').textContent = stats.totalValue.toFixed(2) + ' PLN';
                document.getElementById('categories').textContent = stats.categories;
            }

            showDebugInfo() {
                const debugInfo = {
                    version: 'V9',
                    storageKey: STORAGE_KEY,
                    locationsKey: LOCATIONS_KEY,
                    dataCount: currentData.length,
                    locationsCount: locations.length,
                    searchActive: isSearchActive,
                    filteredCount: filteredData.length,
                    pwaInstallable: !!deferredInstallPrompt,
                    isStandalone: window.matchMedia('(display-mode: standalone)').matches
                };

                document.getElementById('debugInfo').innerHTML = `
                    <strong>Wersja:</strong> ${debugInfo.version} (PWA z lokalizacjami)<br>
                    <strong>Storage Key:</strong> ${debugInfo.storageKey}<br>
                    <strong>Locations Key:</strong> ${debugInfo.locationsKey}<br>
                    <strong>Liczba przedmiotĂłw:</strong> ${debugInfo.dataCount}<br>
                    <strong>Liczba lokalizacji:</strong> ${debugInfo.locationsCount}<br>
                    <strong>Wyszukiwanie aktywne:</strong> ${debugInfo.searchActive ? 'TAK' : 'NIE'}<br>
                    <strong>Wyniki wyszukiwania:</strong> ${debugInfo.filteredCount}<br>
                    <strong>PWA instalowalne:</strong> ${debugInfo.pwaInstallable ? 'TAK' : 'NIE'}<br>
                    <strong>Tryb standalone:</strong> ${debugInfo.isStandalone ? 'TAK' : 'NIE'}<br>
                    <strong>Service Worker:</strong> ${'serviceWorker' in navigator ? 'OBSĹUGIWANY' : 'BRAK'}
                `;
            }

            toggleDebugInfo() {
                const section = document.getElementById('debugSection');
                if (section.style.display === 'none') {
                    this.showDebugInfo();
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            }

            clearAllData() {
                if (!confirm('Czy na pewno chcesz wyczyĹ›ciÄ‡ WSZYSTKIE dane V9 (przedmioty + lokalizacje)? Ta operacja jest nieodwracalna!')) {
                    return;
                }

                currentData = [];
                filteredData = [];
                locations = [];
                isSearchActive = false;
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(LOCATIONS_KEY);
                this.displayInventoryTable();
                this.updateStats();
                this.loadFilterOptions();
                this.showDebugInfo();
                this.clearSearch();
                this.showSuccess('Wszystkie dane V9 zostaĹ‚y wyczyszczone');
            }

            performSearch() {
                const query = document.getElementById('searchInput').value.toLowerCase().trim();
                if (!query) {
                    this.showError('WprowadĹş frazÄ™ do wyszukania');
                    return;
                }

                console.log(`đź”Ť V9 Search: "${query}" in ${currentData.length} items`);

                filteredData = currentData.filter(item => {
                    const matches = (item.Przedmiot && item.Przedmiot.toLowerCase().includes(query)) ||
                                   (item.Numer_katalogowy && item.Numer_katalogowy.toLowerCase().includes(query)) ||
                                   (item.Numery_zamienne && item.Numery_zamienne.toLowerCase().includes(query)) ||
                                   (item.Notatki && item.Notatki.toLowerCase().includes(query)) ||
                                   (item.Producent && item.Producent.toLowerCase().includes(query));
                    
                    if (matches) {
                        console.log(`âś… Found: ${item.Przedmiot} (ID: ${item.ID})`);
                    }
                    return matches;
                });

                isSearchActive = true;
                currentPage = 1;

                const searchInfo = document.getElementById('searchInfo');
                searchInfo.innerHTML = `
                    <i class="fas fa-search mr-2"></i>
                    <strong>Wyszukiwanie:</strong> "${query}" - znaleziono ${filteredData.length} wynikĂłw z ${currentData.length} przedmiotĂłw
                `;
                searchInfo.style.display = 'block';

                document.getElementById('clearSearchBtn').style.display = 'inline-block';

                this.displayInventoryTable();
                console.log(`đźŽŻ V9 Search results: ${filteredData.length} found`);

                if (filteredData.length === 0) {
                    this.showError(`Nie znaleziono wynikĂłw dla: "${query}"`);
                } else {
                    this.showSuccess(`Znaleziono ${filteredData.length} wynikĂłw dla: "${query}"`);
                }
            }

            clearSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchInfo').style.display = 'none';
                document.getElementById('clearSearchBtn').style.display = 'none';
                document.getElementById('searchSuggestions').style.display = 'none';
                
                isSearchActive = false;
                filteredData = [];
                currentPage = 1;
                
                this.displayInventoryTable();
                console.log('đź”„ V9 Search cleared');
            }

            handleSearchInput(e) {
                const query = e.target.value.toLowerCase().trim();
                if (query.length < 2) {
                    document.getElementById('searchSuggestions').style.display = 'none';
                    return;
                }

                const suggestions = currentData.filter(item => 
                    (item.Przedmiot && item.Przedmiot.toLowerCase().includes(query)) ||
                    (item.Numer_katalogowy && item.Numer_katalogowy.toLowerCase().includes(query))
                ).slice(0, 5);

                this.displaySearchSuggestions(suggestions);
            }

            displaySearchSuggestions(suggestions) {
                const container = document.getElementById('searchSuggestions');
                if (suggestions.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.innerHTML = suggestions.map(item => `
                    <div class="suggestion-item" onclick="app.selectSuggestion('${item.Przedmiot || item.Numer_katalogowy}')">
                        <strong>${item.Przedmiot || '-'}</strong> - ${item.Numer_katalogowy || '-'}
                        <br><small>${item.Producent || '-'} | ${item.Lokalizacja || '-'} | ${this.formatCurrency(item.Cena_PLN)}</small>
                    </div>
                `).join('');

                container.style.display = 'block';
            }

            selectSuggestion(text) {
                document.getElementById('searchInput').value = text;
                document.getElementById('searchSuggestions').style.display = 'none';
                this.performSearch();
            }

            applyFilters() {
                if (!isSearchActive) {
                    currentPage = 1;
                    this.displayInventoryTable();
                }
            }

            changePage(direction) {
                const displayData = this.getCurrentDisplayData();
                const totalPages = Math.ceil(displayData.length / itemsPerPage);
                currentPage = Math.max(1, Math.min(totalPages, currentPage + direction));
                this.displayInventoryTable();
            }

            showVoiceModal() {
                this.loadFilterOptions();
                document.getElementById('voiceModal').style.display = 'block';
                document.getElementById('voiceText').focus();
            }

            closeVoiceModal() {
                document.getElementById('voiceModal').style.display = 'none';
                document.getElementById('voiceText').value = '';
                document.getElementById('aiResults').style.display = 'none';
                pendingAIItems = [];
            }

            clearVoiceText() {
                document.getElementById('voiceText').value = '';
                document.getElementById('aiResults').style.display = 'none';
                pendingAIItems = [];
            }

            async processVoiceText() {
                const text = document.getElementById('voiceText').value.trim();
                const location = document.getElementById('voiceLocation').value;

                if (!text) {
                    this.showError('WprowadĹş tekst do przetworzenia');
                    return;
                }

                if (!location) {
                    this.showError('Wybierz lokalizacjÄ™');
                    return;
                }

                document.getElementById('processingMessage').style.display = 'block';

                try {
                    const aiResponse = await this.callDeepSeekAPI(text);
                    this.displayAIResults(aiResponse, location);
                } catch (error) {
                    this.showError('BĹ‚Ä…d przetwarzania AI: ' + error.message);
                } finally {
                    document.getElementById('processingMessage').style.display = 'none';
                }
            }

            // ENHANCED AI PROMPT - V9 keeps all V8 improvements
            async callDeepSeekAPI(text) {
                const prompt = `JesteĹ› eksperckim asystentem inwentaryzacji magazynu. Musisz DOKĹADNIE przeanalizowaÄ‡ tekst uĹĽytkownika i wyodrÄ™bniÄ‡ WSZYSTKIE szczegĂłĹ‚owe informacje o przedmiotach.

TEKST UĹ»YTKOWNIKA: "${text}"

WAĹ»NE ZASADY ANALIZY:
1. ZACHOWUJ WSZYSTKIE SZCZEGĂ“ĹY: rozmiary, objÄ™toĹ›ci, dĹ‚ugoĹ›ci, szerokoĹ›ci, wagi, pojemnoĹ›ci
2. ZACHOWUJ PEĹNE NAZWY FIRM: nie skracaj nazw producentĂłw
3. ZACHOWUJ WSZYSTKIE SPECYFIKACJE: "uniwersalne", "zewnÄ™trzne", "wewnÄ™trzne", "duĹĽe", "maĹ‚e"
4. ZACHOWUJ TYPY OPAKOWAĹ: "5-litrowe", "1kg", "zestaw", "komplet", "opakowanie"
5. DODAWAJ SZCZEGĂ“ĹY DO NAZWY PRZEDMIOTU, nie do notatek

ZwrĂłÄ‡ odpowiedĹş jako JSON array z obiektami zawierajÄ…cymi:
- Przedmiot (PEĹNA nazwa z WSZYSTKIMI szczegĂłĹ‚ami - rozmiar, objÄ™toĹ›Ä‡, specyfikacja)
- Producent (peĹ‚na nazwa firmy jeĹ›li podano)
- Numer_katalogowy (jeĹ›li podano)
- Numery_zamienne (jeĹ›li podano, inaczej pusty string)
- Ilosc (liczba, domyĹ›lnie 1)
- Jednostka (domyĹ›lnie "szt")
- Cena_PLN (liczba dziesiÄ™tna lub 0)
- Kategoria (okreĹ›l odpowiedniÄ… kategoriÄ™)
- Notatki (tylko dodatkowe informacje, nie duplikuj szczegĂłĹ‚Ăłw z nazwy przedmiotu)

PRZYKĹADY POPRAWNEJ ANALIZY:
Tekst: "2 opakowania 5-litrowe oleju 10W40 po 74 zĹ‚"
Wynik: "Przedmiot": "Olej silnikowy 10W40 opakowanie 5-litrowe"

Tekst: "noĹĽyce do blachy Yato dĹ‚ugoĹ›Ä‡ 40mm"
Wynik: "Przedmiot": "NoĹĽyce do ciÄ™cia blachy Yato 40mm"

Tekst: "15 osĹ‚on przegubĂłw zewnÄ™trznych uniwersalnych Dura Bot po 16 zĹ‚"
Wynik: "Przedmiot": "OsĹ‚ona przegubu zewnÄ™trznego uniwersalna Dura Bot"

Tekst: "mĹ‚otki duĹĽe kilogramowe nowe"
Wynik: "Przedmiot": "MĹ‚otek duĹĽy kilogramowy"

Odpowiedz TYLKO JSON array, bez dodatkowych komentarzy.`;

                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.1,
                        max_tokens: 3000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0]?.message?.content;

                if (!aiResponse) {
                    throw new Error('Brak odpowiedzi z AI');
                }

                // Clean up the response and parse JSON
                let cleanedResponse = aiResponse.trim();
                if (cleanedResponse.startsWith('```json')) {
                    cleanedResponse = cleanedResponse.replace(/```json\n?/, '').replace(/```$/, '');
                }

                return JSON.parse(cleanedResponse);
            }

            displayAIResults(results, location) {
                if (!Array.isArray(results) || results.length === 0) {
                    this.showError('AI nie rozpoznaĹ‚o ĹĽadnych przedmiotĂłw');
                    return;
                }

                // Add location to the locations list if it doesn't exist
                if (!locations.includes(location)) {
                    locations.push(location);
                    this.saveLocationsToStorage();
                    this.loadFilterOptions();
                    console.log(`đź“Ť Auto-dodano nowÄ… lokalizacjÄ™: ${location}`);
                }

                pendingAIItems = results.map(item => ({
                    ...item,
                    Budynek: 'Sklep',
                    Lokalizacja: location,
                    Data_dodania: new Date().toISOString().split('T')[0],
                    Status: 'aktywny'
                }));

                const resultsHTML = pendingAIItems.map((item, index) => `
                    <div class="border border-gray-200 rounded p-3 mb-2">
                        <div class="font-semibold text-green-700">${item.Przedmiot}</div>
                        <div class="text-sm text-gray-600 grid grid-cols-2 gap-2 mt-1">
                            <div><strong>Producent:</strong> ${item.Producent || '-'}</div>
                            <div><strong>Nr kat.:</strong> ${item.Numer_katalogowy || '-'}</div>
                            <div><strong>IloĹ›Ä‡:</strong> ${item.Ilosc} ${item.Jednostka}</div>
                            <div><strong>Cena:</strong> ${this.formatCurrency(item.Cena_PLN)}</div>
                            <div><strong>Kategoria:</strong> ${item.Kategoria}</div>
                            <div><strong>Lokalizacja:</strong> ${item.Lokalizacja}</div>
                            ${item.Notatki ? `<div class="col-span-2"><strong>Notatki:</strong> ${item.Notatki}</div>` : ''}
                        </div>
                    </div>
                `).join('');

                document.getElementById('aiResultsList').innerHTML = resultsHTML;
                document.getElementById('aiResults').style.display = 'block';
            }

            saveAIItems() {
                if (pendingAIItems.length === 0) {
                    this.showError('Brak przedmiotĂłw do zapisania');
                    return;
                }

                const maxId = currentData.length > 0 ? Math.max(...currentData.map(item => item.ID)) : 0;
                
                pendingAIItems.forEach((item, index) => {
                    currentData.push({
                        ...item,
                        ID: maxId + index + 1
                    });
                });

                this.saveToLocalStorage();
                this.displayInventoryTable();
                this.updateStats();
                this.loadFilterOptions();

                this.showSuccess(`Dodano ${pendingAIItems.length} przedmiotĂłw przez AI`);
                this.closeVoiceModal();
            }

            showImportModal() {
                document.getElementById('importModal').style.display = 'block';
            }

            closeImportModal() {
                document.getElementById('importModal').style.display = 'none';
                document.getElementById('csvFileInput').value = '';
                document.getElementById('importPreview').style.display = 'none';
            }

            previewCSV() {
                const fileInput = document.getElementById('csvFileInput');
                if (!fileInput.files[0]) return;

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        
                        const headers = this.parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                        const dataLines = lines.slice(1);
                        
                        let totalValue = 0;
                        let validRows = 0;
                        
                        for (let i = 0; i < Math.min(dataLines.length, 10); i++) {
                            const values = this.parseCSVLine(dataLines[i]);
                            if (values.length === headers.length) {
                                validRows++;
                                const priceIndex = headers.indexOf('Cena_PLN');
                                const quantityIndex = headers.indexOf('Ilosc');
                                if (priceIndex >= 0 && quantityIndex >= 0) {
                                    const price = parseFloat(values[priceIndex].replace(/"/g, '')) || 0;
                                    const quantity = parseInt(values[quantityIndex].replace(/"/g, '')) || 0;
                                    totalValue += price * quantity;
                                }
                            }
                        }

                        document.getElementById('importStats').innerHTML = `
                            <strong>PodglÄ…d pliku:</strong><br>
                            Nazwa: ${file.name}<br>
                            Rozmiar: ${(file.size / 1024).toFixed(1)} KB<br>
                            Wierszy: ${dataLines.length}<br>
                            Kolumn: ${headers.length}<br>
                            PrzykĹ‚adowa wartoĹ›Ä‡ (10 pierwszych): ${totalValue.toFixed(2)} PLN<br>
                            <small>Kolumny: ${headers.join(', ')}</small>
                        `;

                        document.getElementById('importPreview').style.display = 'block';

                    } catch (error) {
                        console.error('Preview error:', error);
                        this.showError('BĹ‚Ä…d podglÄ…du CSV: ' + error.message);
                    }
                };

                reader.readAsText(file);
            }

            processCSVImport() {
                const fileInput = document.getElementById('csvFileInput');
                const importMode = document.getElementById('importMode').value;
                
                if (!fileInput.files[0]) {
                    this.showError('Wybierz plik CSV');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        console.log('đź”„ V9 CSV Import rozpoczÄ™ty');
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            this.showError('Plik CSV musi zawieraÄ‡ nagĹ‚Ăłwki i co najmniej jeden wiersz danych');
                            return;
                        }

                        const headers = this.parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                        const data = [];
                        let skippedRows = 0;
                        const importedLocations = new Set();

                        console.log('đź“‹ NagĹ‚Ăłwki CSV:', headers);

                        for (let i = 1; i < lines.length; i++) {
                            const values = this.parseCSVLine(lines[i]);
                            if (values.length !== headers.length) {
                                skippedRows++;
                                continue;
                            }

                            const item = {};
                            headers.forEach((header, index) => {
                                let value = values[index].trim().replace(/^"|"$/g, '');
                                
                                if (header === 'ID' || header === 'Ilosc') {
                                    value = parseInt(value) || 0;
                                } else if (header === 'Cena_PLN') {
                                    value = this.parsePrice(value);
                                }
                                
                                item[header] = value;
                            });

                            // Collect locations
                            if (item.Lokalizacja && item.Lokalizacja.trim()) {
                                importedLocations.add(item.Lokalizacja.trim());
                            }

                            data.push(item);
                        }

                        console.log(`đź“Š Zaimportowano ${data.length} przedmiotĂłw, pominiÄ™to ${skippedRows} wierszy`);

                        // Update locations
                        importedLocations.forEach(location => {
                            if (!locations.includes(location)) {
                                locations.push(location);
                                console.log(`đź“Ť Auto-dodano lokalizacjÄ™ z CSV: ${location}`);
                            }
                        });

                        const totalValue = data.filter(item => item.Status === 'aktywny')
                            .reduce((sum, item) => {
                                const price = parseFloat(item.Cena_PLN) || 0;
                                const quantity = parseInt(item.Ilosc) || 0;
                                return sum + (price * quantity);
                            }, 0);

                        console.log(`đź’° Obliczona wartoĹ›Ä‡ importu: ${totalValue.toFixed(2)} PLN`);

                        if (importMode === 'replace') {
                            currentData = data;
                            console.log('đź”„ ZastÄ…piono wszystkie dane');
                        } else {
                            const maxId = currentData.length > 0 ? Math.max(...currentData.map(item => item.ID)) : 0;
                            data.forEach((item, index) => {
                                item.ID = maxId + index + 1;
                                currentData.push(item);
                            });
                            console.log('âž• Dodano do istniejÄ…cych danych');
                        }

                        this.clearSearch();

                        this.saveToLocalStorage();
                        this.saveLocationsToStorage();
                        this.displayInventoryTable();
                        this.updateStats();
                        this.loadFilterOptions();
                        this.showDebugInfo();

                        this.showSuccess(`âś… Zaimportowano ${data.length} przedmiotĂłw i ${importedLocations.size} lokalizacji. WartoĹ›Ä‡: ${totalValue.toFixed(2)} PLN`);
                        this.closeImportModal();

                    } catch (error) {
                        console.error('âťŚ BĹ‚Ä…d importu CSV:', error);
                        this.showError('BĹ‚Ä…d parsowania CSV: ' + error.message);
                    }
                };

                reader.readAsText(file);
            }

            parsePrice(value) {
                if (!value || value === '') return 0;
                
                let cleanValue = value.toString().replace(/[^\d.,]/g, '');
                
                if (cleanValue.includes(',') && !cleanValue.includes('.')) {
                    cleanValue = cleanValue.replace(',', '.');
                } else if (cleanValue.includes(',') && cleanValue.includes('.')) {
                    const lastDot = cleanValue.lastIndexOf('.');
                    const lastComma = cleanValue.lastIndexOf(',');
                    if (lastComma > lastDot) {
                        cleanValue = cleanValue.replace(/\./g, '').replace(',', '.');
                    } else {
                        cleanValue = cleanValue.replace(/,/g, '');
                    }
                }
                
                const parsed = parseFloat(cleanValue) || 0;
                return parsed;
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result;
            }

            exportCSV() {
                if (currentData.length === 0) {
                    this.showError('Brak danych do eksportu');
                    return;
                }

                const headers = ['ID', 'Budynek', 'Lokalizacja', 'Kategoria', 'Przedmiot', 'Producent', 
                               'Numer_katalogowy', 'Numery_zamienne', 'Ilosc', 'Jednostka', 'Cena_PLN', 
                               'Data_dodania', 'Status', 'Notatki'];
                
                const csvContent = [
                    headers.join(','),
                    ...currentData.map(item => 
                        headers.map(header => {
                            const value = item[header] || '';
                            return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
                                ? `"${value.replace(/"/g, '""')}"` 
                                : value;
                        }).join(',')
                    )
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `magazyn_v9_backup_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showSuccess('Plik CSV V9 zostaĹ‚ pobrany');
            }

            editField(id, field) {
                const item = currentData.find(item => item.ID === id);
                if (!item) return;

                const cell = event.target;
                const currentValue = item[field] || '';
                
                cell.innerHTML = `<input type="text" class="edit-input" value="${currentValue}" onblur="app.saveField(${id}, '${field}', this.value)" onkeypress="if(event.key==='Enter') this.blur()">`;
                cell.querySelector('input').focus();
            }

            saveField(id, field, newValue) {
                const item = currentData.find(item => item.ID === id);
                if (item) {
                    item[field] = newValue;
                    this.saveToLocalStorage();
                    this.displayInventoryTable();
                    this.updateStats();
                    console.log(`âśŹď¸Ź Zaktualizowano ${field} dla ID ${id}: ${newValue}`);
                }
            }

            editItem(id) {
                this.editField(id, 'Przedmiot');
            }

            deleteItem(id) {
                if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ ten przedmiot?')) return;
                
                const item = currentData.find(item => item.ID === id);
                if (item) {
                    item.Status = 'usuniÄ™ty';
                    this.saveToLocalStorage();
                    
                    if (isSearchActive) {
                        const filteredIndex = filteredData.findIndex(filterItem => filterItem.ID === id);
                        if (filteredIndex >= 0) {
                            filteredData[filteredIndex].Status = 'usuniÄ™ty';
                        }
                    }
                    
                    this.displayInventoryTable();
                    this.updateStats();
                    this.showSuccess('Przedmiot zostaĹ‚ oznaczony jako usuniÄ™ty');
                    console.log(`đź—‘ď¸Ź UsuniÄ™to przedmiot ID ${id}: ${item.Przedmiot}`);
                }
            }

            saveToLocalStorage() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
                console.log(`đź’ľ Zapisano ${currentData.length} przedmiotĂłw do localStorage (${STORAGE_KEY})`);
            }

            loadFromLocalStorage() {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    currentData = JSON.parse(data);
                    console.log(`đź“‚ ZaĹ‚adowano ${currentData.length} przedmiotĂłw z localStorage (${STORAGE_KEY})`);
                } else {
                    console.log('đź“‚ Brak danych w localStorage dla V9');
                }
            }

            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showNotification(message, type) {
                console.log(`${type === 'success' ? 'âś…' : 'âťŚ'} ${message}`);
                
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                }`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 5000);
            }
        }

        // Initialize app - V9 z systemem logowania
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            console.log('đźš€ Inicjalizacja Inwentaryzacji Magazynu V9 - v2b (naprawa funkcji)');
            
            // SprawdĹş logowanie na poczÄ…tku - jeĹ›li nie zalogowany, pokaĹĽe formularz
            checkLogin();
        });
    </script>
</body>
</html>
